<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mobile Camera App</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #111;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100dvh;
      overflow: hidden;
    }
    #camera {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      width: 100%;
      position: relative;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #captureBtn {
      position: absolute;
      bottom: calc(15px + env(safe-area-inset-bottom, 0px));
      left: 50%;
      transform: translateX(-50%);
      width: clamp(56px, 9vw, 88px);
      height: clamp(56px, 9vw, 88px);
      border-radius: 50%;
      border: clamp(3px, 0.8vw, 6px) solid #fff;
      background: #ff3b30;
      box-shadow: 0 0 15px rgba(255, 59, 48, 0.8);
    }
    #toolbar {
      display: flex;
      justify-content: space-around;
      align-items: center;
      background: #222;
      padding: clamp(6px, 1.5vh, 10px);
      width: 100%;
    }
    .tool-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: clamp(18px, 2.6vw, 24px);
      cursor: pointer;
      padding: 6px 8px;
    }
    #gallery {
      background: #111;
      width: 100%;
      padding: 8px;
      display: flex;
      gap: 8px;
      overflow-x: auto;
      scrollbar-width: none;
    }
    #gallery::-webkit-scrollbar { display: none; }
    .thumb-item {
      position: relative;
      flex: 0 0 auto;
      width: clamp(64px, 12vw, 110px);
      height: clamp(64px, 12vw, 110px);
    }
    .thumb {
      width: 100%;
      height: 100%;
      border-radius: 8px;
      object-fit: cover;
      border: 2px solid #333;
      display: block;
    }
    .thumb-actions {
      position: absolute;
      right: 4px;
      bottom: 4px;
      display: flex;
      gap: 4px;
    }
    .mini-btn {
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      font-size: 12px;
      padding: 3px 6px;
      border-radius: 6px;
      cursor: pointer;
    }
    /* Modal base */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 12px;
      width: min(100%, 920px);
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid #333;
      background: #111;
    }
    .modal-title { font-weight: bold; }
    .close-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
    }
    .modal-body { padding: 12px; overflow: auto; }
    /* Library grid */
    .lib-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
    }
    .lib-item { position: relative; }
    .lib-thumb {
      width: 100%;
      aspect-ratio: 1/1;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #333;
      display: block;
      cursor: pointer;
    }
    .lib-actions {
      position: absolute;
      right: 6px;
      bottom: 6px;
      display: flex;
      gap: 6px;
    }
    .btn {
      background: #2a2a2a;
      border: 1px solid #444;
      color: #fff;
      border-radius: 8px;
      padding: 8px 10px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn.primary { background: #0a84ff; border-color: #0a84ff; }
    .btn.danger { background: #ff453a; border-color: #ff453a; }
    /* Preview modal */
    .preview-image {
      max-width: 90vw;
      max-height: 70dvh;
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: 10px;
      border: 1px solid #333;
      display: block;
      margin: 0 auto;
      background: #000;
    }
    .preview-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      padding-top: 12px;
    }

    /* Responsive tweaks for landscape / small heights */
    @media (orientation: landscape) and (max-height: 520px) {
      #toolbar { padding: 6px; }
      .tool-btn { font-size: clamp(16px, 2.2vw, 20px); }
      #captureBtn {
        width: clamp(48px, 8vh, 70px);
        height: clamp(48px, 8vh, 70px);
      }
      .thumb-item {
        width: clamp(56px, 10vh, 90px);
        height: clamp(56px, 10vh, 90px);
      }
    }
  </style>
</head>
<body>
  <div id="camera">
    <video id="video" autoplay playsinline></video>
    <button id="captureBtn"></button>
  </div>

  <div id="toolbar">
    <button class="tool-btn" id="switchCam">üîÑ</button>
    <button class="tool-btn" id="flash">‚ö°</button>
    <button class="tool-btn" id="settings">‚öôÔ∏è</button>
    <button class="tool-btn" id="autoSaveToggle" title="T·ª± ƒë·ªông t·∫£i ·∫£nh">üíæ OFF</button>
    <button class="tool-btn" id="openLibrary" title="Xem th∆∞ vi·ªán">üñºÔ∏è</button>
  </div>

  <div id="gallery"></div>

  <!-- Library Modal -->
  <div id="libraryModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Th∆∞ vi·ªán ·∫£nh</div>
        <button class="close-btn" data-close-lib>‚úñ</button>
      </div>
      <div class="modal-body">
        <div id="libraryGrid" class="lib-grid"></div>
      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div id="previewModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Xem ·∫£nh</div>
        <button class="close-btn" data-close-preview>‚úñ</button>
      </div>
      <div class="modal-body">
        <img id="previewImage" class="preview-image" alt="Preview" />
        <div class="preview-actions">
          <button id="downloadPreview" class="btn primary">T·∫£i xu·ªëng</button>
          <button id="deletePreview" class="btn danger">X√≥a</button>
        </div>
      </div>
    </div>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const gallery = document.getElementById('gallery');
    const openLibraryBtn = document.getElementById('openLibrary');
    const autoSaveToggle = document.getElementById('autoSaveToggle');
    const libraryModal = document.getElementById('libraryModal');
    const libraryGrid = document.getElementById('libraryGrid');
    const previewModal = document.getElementById('previewModal');
    const previewImage = document.getElementById('previewImage');
    const downloadPreviewBtn = document.getElementById('downloadPreview');
    const deletePreviewBtn = document.getElementById('deletePreview');
    let currentStream;
    let useFront = true;
    let photos = [];
    let activePhotoId = null;
    let autoSave = false;

    // ===== IndexedDB persistence =====
    const DB_NAME = 'camera-db';
    const DB_VERSION = 1;
    const STORE_PHOTOS = 'photos';

    function openDb() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(STORE_PHOTOS)) {
            const store = db.createObjectStore(STORE_PHOTOS, { keyPath: 'id' });
            store.createIndex('createdAt', 'createdAt');
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function dbSavePhoto(photo) {
      try {
        const db = await openDb();
        await new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_PHOTOS, 'readwrite');
          tx.objectStore(STORE_PHOTOS).put(photo);
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        });
      } catch (e) {
        console.error('L·ªói l∆∞u ·∫£nh v√†o cache', e);
      }
    }

    async function dbDeletePhoto(id) {
      try {
        const db = await openDb();
        await new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_PHOTOS, 'readwrite');
          tx.objectStore(STORE_PHOTOS).delete(id);
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        });
      } catch (e) {
        console.error('L·ªói x√≥a ·∫£nh trong cache', e);
      }
    }

    async function dbLoadAllPhotos() {
      try {
        const db = await openDb();
        return await new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_PHOTOS, 'readonly');
          const req = tx.objectStore(STORE_PHOTOS).getAll();
          req.onsuccess = () => {
            const list = req.result || [];
            // S·∫Øp x·∫øp m·ªõi nh·∫•t tr∆∞·ªõc
            list.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            resolve(list);
          };
          req.onerror = () => reject(req.error);
        });
      } catch (e) {
        console.error('L·ªói t·∫£i ·∫£nh t·ª´ cache', e);
        return [];
      }
    }

    async function initCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }
      currentStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: useFront ? 'user' : 'environment' }
      });
      video.srcObject = currentStream;
    }

    captureBtn.onclick = () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      const dataUrl = canvas.toDataURL('image/png');
      const photo = addPhoto(dataUrl);
      if (autoSave && photo) {
        downloadPhoto(photo.id);
      }
    };

    function addPhoto(dataUrl) {
      const id = 'p_' + Date.now() + '_' + Math.random().toString(36).slice(2, 8);
      const index = photos.length + 1;
      const filename = `photo_${index}.png`;
      const createdAt = Date.now();
      const photo = { id, dataUrl, filename, createdAt };
      photos.unshift(photo);
      renderThumbRow();
      if (libraryModal.classList.contains('show')) renderLibrary();
      // L∆∞u v√†o IndexedDB ƒë·ªÉ cache ngo·∫°i tuy·∫øn
      dbSavePhoto(photo);
      return photo;
    }

    function renderThumbRow() {
      gallery.innerHTML = '';
      photos.forEach((p) => {
        const item = document.createElement('div');
        item.className = 'thumb-item';
        item.dataset.id = p.id;

        const img = document.createElement('img');
        img.src = p.dataUrl;
        img.className = 'thumb';
        img.alt = p.filename;
        img.addEventListener('click', () => openPreview(p.id));

        const actions = document.createElement('div');
        actions.className = 'thumb-actions';

        const dl = document.createElement('button');
        dl.className = 'mini-btn';
        dl.textContent = '‚Üì';
        dl.title = 'T·∫£i xu·ªëng';
        dl.addEventListener('click', (e) => {
          e.stopPropagation();
          downloadPhoto(p.id);
        });

        const del = document.createElement('button');
        del.className = 'mini-btn';
        del.textContent = '‚úñ';
        del.title = 'X√≥a';
        del.addEventListener('click', (e) => {
          e.stopPropagation();
          deletePhoto(p.id);
        });

        actions.appendChild(dl);
        actions.appendChild(del);
        item.appendChild(img);
        item.appendChild(actions);
        gallery.appendChild(item);
      });
    }

    function openLibrary() {
      renderLibrary();
      libraryModal.classList.add('show');
      libraryModal.setAttribute('aria-hidden', 'false');
    }

    function closeLibrary() {
      libraryModal.classList.remove('show');
      libraryModal.setAttribute('aria-hidden', 'true');
    }

    function renderLibrary() {
      libraryGrid.innerHTML = '';
      photos.forEach((p) => {
        const item = document.createElement('div');
        item.className = 'lib-item';
        item.dataset.id = p.id;

        const img = document.createElement('img');
        img.src = p.dataUrl;
        img.className = 'lib-thumb';
        img.alt = p.filename;
        img.addEventListener('click', () => openPreview(p.id));

        const actions = document.createElement('div');
        actions.className = 'lib-actions';

        const dl = document.createElement('button');
        dl.className = 'mini-btn';
        dl.textContent = 'T·∫£i';
        dl.addEventListener('click', (e) => {
          e.stopPropagation();
          downloadPhoto(p.id);
        });

        const del = document.createElement('button');
        del.className = 'mini-btn';
        del.textContent = 'X√≥a';
        del.addEventListener('click', (e) => {
          e.stopPropagation();
          deletePhoto(p.id);
        });

        actions.appendChild(dl);
        actions.appendChild(del);
        item.appendChild(img);
        item.appendChild(actions);
        libraryGrid.appendChild(item);
      });
    }

    function openPreview(photoId) {
      const photo = photos.find(x => x.id === photoId);
      if (!photo) return;
      activePhotoId = photoId;
      previewImage.src = photo.dataUrl;
      previewImage.alt = photo.filename;
      previewModal.classList.add('show');
      previewModal.setAttribute('aria-hidden', 'false');
    }

    function closePreview() {
      previewModal.classList.remove('show');
      previewModal.setAttribute('aria-hidden', 'true');
      activePhotoId = null;
    }

    function downloadPhoto(photoId) {
      const photo = photos.find(x => x.id === photoId);
      if (!photo) return;
      const a = document.createElement('a');
      a.href = photo.dataUrl;
      a.download = photo.filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function deletePhoto(photoId) {
      const i = photos.findIndex(x => x.id === photoId);
      if (i === -1) return;
      photos.splice(i, 1);
      renderThumbRow();
      if (libraryModal.classList.contains('show')) renderLibrary();
      if (activePhotoId === photoId) closePreview();
      // X√≥a kh·ªèi IndexedDB
      dbDeletePhoto(photoId);
    }

    document.getElementById('switchCam').onclick = () => {
      useFront = !useFront;
      initCamera();
    };

    // Auto save toggle
    function updateAutoSaveBtn() {
      autoSaveToggle.textContent = autoSave ? 'üíæ ON' : 'üíæ OFF';
      autoSaveToggle.style.color = autoSave ? '#0a84ff' : '#fff';
    }
    autoSaveToggle.addEventListener('click', () => {
      autoSave = !autoSave;
      updateAutoSaveBtn();
    });
    updateAutoSaveBtn();

    // Toolbar: open library
    openLibraryBtn.addEventListener('click', openLibrary);

    // Close buttons and backdrop click
    libraryModal.addEventListener('click', (e) => {
      if (e.target === libraryModal || e.target.hasAttribute('data-close-lib')) closeLibrary();
    });
    previewModal.addEventListener('click', (e) => {
      if (e.target === previewModal || e.target.hasAttribute('data-close-preview')) closePreview();
    });

    // Preview actions
    downloadPreviewBtn.addEventListener('click', () => {
      if (activePhotoId) downloadPhoto(activePhotoId);
    });
    deletePreviewBtn.addEventListener('click', () => {
      if (activePhotoId) deletePhoto(activePhotoId);
    });

    // Kh·ªüi ƒë·ªông: t·∫£i ·∫£nh t·ª´ cache r·ªìi b·∫≠t camera
    (async () => {
      const cached = await dbLoadAllPhotos();
      if (Array.isArray(cached) && cached.length) {
        photos = cached;
        renderThumbRow();
      }
      initCamera();
    })();
  </script>
</body>
</html>
