<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google" content="notranslate">
  <title>Text2 - Camera</title>
<!-- Google tag (gtag.js) - GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ABCDEFG123"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6J85STMJ14');
</script>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #111;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      /* Enhanced full-height handling for browser UI */
      min-height: 100vh;
      min-height: 100dvh; /* Dynamic viewport height */
      height: 100vh;
      height: 100dvh;
      overflow: hidden;
      overscroll-behavior: none;
      /* Use CSS env() for safe areas */
      padding-top: env(safe-area-inset-top, 0px);
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }
    
    /* Adaptive container that responds to viewport changes */
    .app-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      max-height: 100vh;
      max-height: 100dvh;
    }
    
    #camera {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      width: 100%;
      position: relative;
      min-height: 0; /* Allow flex shrinking */
      /* Ensure camera doesn't get too small */
      min-height: clamp(200px, 40vh, 400px);
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #captureBtn {
      position: absolute;
      bottom: clamp(10px, 2vh, 20px);
      left: 50%;
      transform: translateX(-50%);
      width: clamp(50px, 8vh, 80px);
      height: clamp(50px, 8vh, 80px);
      border-radius: 50%;
      border: clamp(2px, 0.5vh, 5px) solid #fff;
      background: #ff3b30;
      box-shadow: 0 0 15px rgba(255, 59, 48, 0.8);
      z-index: 10;
    }
    #toolbar {
      display: flex;
      justify-content: space-around;
      align-items: center;
      background: #222;
      padding: clamp(4px, 1vh, 8px);
      width: 100%;
      flex-shrink: 0; /* Don't shrink toolbar */
      min-height: clamp(40px, 6vh, 60px);
    }
    .tool-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: clamp(14px, 2vh, 20px);
      cursor: pointer;
      padding: clamp(4px, 0.8vh, 8px);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    /* Modal base */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 12px;
      width: min(100%, 920px);
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid #333;
      background: #111;
    }
    .modal-title { font-weight: bold; }
    .close-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
    }
    .modal-body { padding: 12px; overflow: auto; }
    /* Library grid */
    .lib-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
    }
    .lib-item { position: relative; }
    .lib-thumb {
      width: 100%;
      aspect-ratio: 1/1;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #333;
      display: block;
      cursor: pointer;
    }
    .lib-actions {
      position: absolute;
      right: 6px;
      bottom: 6px;
      display: flex;
      gap: 6px;
    }
    .btn {
      background: #2a2a2a;
      border: 1px solid #444;
      color: #fff;
      border-radius: 8px;
      padding: 8px 10px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn.primary { background: #0a84ff; border-color: #0a84ff; }
    .btn.danger { background: #ff453a; border-color: #ff453a; }
    /* Preview modal */
    .preview-image {
      max-width: 90vw;
      max-height: 70dvh;
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: 10px;
      border: 1px solid #333;
      display: block;
      margin: 0 auto;
      background: #000;
    }
    .preview-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      padding-top: 12px;
    }

    /* Enhanced responsive breakpoints */
    @media (max-height: 600px) {
      #camera { min-height: clamp(150px, 35vh, 300px); }
      #toolbar { min-height: clamp(35px, 5vh, 50px); }
      #gallery { max-height: clamp(50px, 10vh, 100px); }
      .thumb-item {
        width: clamp(45px, 9vh, 85px);
        height: clamp(45px, 9vh, 85px);
      }
      #captureBtn {
        width: clamp(45px, 7vh, 70px);
        height: clamp(45px, 7vh, 70px);
      }
    }
    
    @media (max-height: 500px) {
      #camera { min-height: clamp(120px, 30vh, 250px); }
      #toolbar { 
        min-height: clamp(30px, 4vh, 45px);
        padding: clamp(2px, 0.5vh, 6px);
      }
      #gallery { 
        max-height: clamp(40px, 8vh, 80px);
        padding: clamp(2px, 0.5vh, 6px);
      }
      .thumb-item {
        width: clamp(40px, 8vh, 70px);
        height: clamp(40px, 8vh, 70px);
      }
      #captureBtn {
        width: clamp(40px, 6vh, 60px);
        height: clamp(40px, 6vh, 60px);
        bottom: clamp(8px, 1.5vh, 15px);
      }
      .tool-btn { 
        font-size: clamp(12px, 1.8vh, 18px);
        padding: clamp(3px, 0.6vh, 6px);
      }
    }
    
    @media (max-height: 400px) {
      #camera { min-height: clamp(100px, 25vh, 200px); }
      #toolbar { 
        min-height: clamp(25px, 3vh, 40px);
        padding: clamp(1px, 0.3vh, 4px);
      }
      #gallery { 
        max-height: clamp(35px, 7vh, 70px);
        padding: clamp(1px, 0.3vh, 4px);
      }
      .thumb-item {
        width: clamp(35px, 7vh, 60px);
        height: clamp(35px, 7vh, 60px);
      }
      #captureBtn {
        width: clamp(35px, 5vh, 55px);
        height: clamp(35px, 5vh, 55px);
        bottom: clamp(5px, 1vh, 10px);
      }
      .tool-btn { 
        font-size: clamp(10px, 1.5vh, 16px);
        padding: clamp(2px, 0.4vh, 5px);
      }
      .mini-btn {
        font-size: clamp(8px, 1.5vh, 10px);
        padding: clamp(1px, 0.2vh, 3px) clamp(3px, 0.5vh, 5px);
      }
    }

    /* Responsive tweaks for landscape / small heights */
    @media (orientation: landscape) and (max-height: 520px) {
      body { 
        padding-top: max(env(safe-area-inset-top, 0px), 5px);
        padding-bottom: max(env(safe-area-inset-bottom, 0px), 5px);
      }
      #camera { min-height: clamp(120px, 30vh, 300px); }
      #toolbar { 
        padding: clamp(3px, 0.6vh, 8px);
        min-height: clamp(30px, 4vh, 50px);
      }
      .tool-btn { font-size: clamp(14px, 2vh, 18px); }
      #captureBtn {
        width: clamp(40px, 6vh, 65px);
        height: clamp(40px, 6vh, 65px);
        bottom: clamp(8px, 1.5vh, 15px);
      }
      .thumb-item {
        width: clamp(45px, 8vh, 80px);
        height: clamp(45px, 8vh, 80px);
      }
      #gallery { 
        max-height: clamp(45px, 9vh, 90px);
        padding: clamp(3px, 0.6vh, 8px);
      }
    }
    
    /* Ultra-compact mode for very constrained spaces */
    @media (orientation: landscape) and (max-height: 400px) {
      #camera { min-height: clamp(80px, 25vh, 200px); }
      #toolbar { 
        padding: clamp(2px, 0.4vh, 6px);
        min-height: clamp(25px, 3vh, 40px);
      }
      .tool-btn { 
        font-size: clamp(12px, 1.8vh, 16px);
        padding: clamp(2px, 0.4vh, 6px);
      }
      #captureBtn {
        width: clamp(35px, 5vh, 55px);
        height: clamp(35px, 5vh, 55px);
        bottom: clamp(5px, 1vh, 10px);
      }
      .thumb-item {
        width: clamp(35px, 7vh, 70px);
        height: clamp(35px, 7vh, 70px);
      }
      #gallery { 
        max-height: clamp(35px, 8vh, 80px);
        padding: clamp(2px, 0.4vh, 6px);
      }
    }
    /* iOS-style button */
    .ios-btn {
      padding: 12px 24px;
      border-radius: 9999px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(42, 42, 42, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 16px;
      font-weight: 500;
      color: #ffffff;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .ios-btn:hover {
      background: rgba(60, 60, 60, 0.9);
      border-color: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }
    .ios-btn:active { 
      background: rgba(30, 30, 30, 0.9);
      transform: translateY(0px);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.4);
    }
    /* Size variants aligned to existing UI */
    .tool-btn.ios-btn { 
      padding: 8px 14px; 
      font-size: clamp(14px, 2.2vw, 16px);
      background: rgba(34, 34, 34, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    .mini-btn.ios-btn { 
      padding: 4px 8px; 
      font-size: 12px;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .btn.ios-btn { 
      padding: 10px 16px; 
      font-size: 14px;
      background: rgba(42, 42, 42, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .btn.primary.ios-btn { 
      color: #ffffff; 
      background: rgba(10, 132, 255, 0.8);
      border: 1px solid rgba(10, 132, 255, 0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .btn.primary.ios-btn:hover {
      background: rgba(10, 132, 255, 0.9);
      border-color: rgba(10, 132, 255, 0.8);
    }
    .btn.danger.ios-btn { 
      color: #ffffff; 
      background: rgba(255, 69, 58, 0.8);
      border: 1px solid rgba(255, 69, 58, 0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .btn.danger.ios-btn:hover {
      background: rgba(255, 69, 58, 0.9);
      border-color: rgba(255, 69, 58, 0.8);
    }
    /* Settings menu */
    #settingsMenu {
      position: fixed;
      right: 10px;
      top: calc(52px + env(safe-area-inset-top, 0px));
      background: rgba(26,26,26,0.95);
      border: 1px solid #333;
      border-radius: 10px;
      padding: 8px;
      display: none;
      z-index: 1200;
      box-shadow: 0 6px 24px rgba(0,0,0,0.4);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    #settingsMenu.show { display: block; }
    #settingsMenu .menu-item { margin: 4px 0; }
  </style>
  <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>
</head>
<body>
  <div id="camera">
    <video id="video" autoplay playsinline muted></video>
    <button id="captureBtn"></button>
  </div>

  <div id="toolbar">
    <button class="tool-btn ios-btn" id="switchCam" aria-label="Switch camera"><iconify-icon icon="ion:camera-reverse-outline"></iconify-icon></button>
    <button class="tool-btn ios-btn" id="settings" aria-label="Settings"><iconify-icon icon="ion:settings-outline"></iconify-icon></button>
    <button class="tool-btn ios-btn" id="autoSaveToggle" title="Auto download photos" aria-pressed="false"></button>
    <button class="tool-btn ios-btn" id="openLibrary" title="View library" aria-label="Library"><iconify-icon icon="ion:images-outline"></iconify-icon></button>
  </div>

  <!-- Settings Menu -->
  <div id="settingsMenu" role="menu" aria-hidden="true">
    <button id="btnReloadAssets" class="btn ios-btn menu-item"><iconify-icon icon="ion:refresh-outline"></iconify-icon><span>Update</span></button>
  </div>

  <!-- Library Modal -->
  <div id="libraryModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Photo Library</div>
        <button class="close-btn ios-btn" data-close-lib aria-label="Close"><iconify-icon icon="ion:close-outline"></iconify-icon></button>
      </div>
      <div class="modal-body">
        <div id="libraryGrid" class="lib-grid"></div>
      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div id="previewModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">View Photo</div>
        <button class="close-btn ios-btn" data-close-preview aria-label="Close"><iconify-icon icon="ion:close-outline"></iconify-icon></button>
      </div>
      <div class="modal-body">
        <img id="previewImage" class="preview-image" alt="Preview" />
        <div class="preview-actions">
          <button id="downloadPreview" class="btn primary ios-btn"><iconify-icon icon="ion:download-outline"></iconify-icon><span>Download</span></button>
          <button id="deletePreview" class="btn danger ios-btn"><iconify-icon icon="ion:trash-outline"></iconify-icon><span>Delete</span></button>
        </div>
      </div>
    </div>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    // Viewport height fix for mobile browsers UI chrome
    function setAppVhUnit() {
      const vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
      document.documentElement.style.setProperty('--app-vh', `${vh * 0.01}px`);
    }
    setAppVhUnit();
    window.addEventListener('resize', setAppVhUnit, { passive: true });
    window.addEventListener('orientationchange', setAppVhUnit, { passive: true });

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const openLibraryBtn = document.getElementById('openLibrary');
    const autoSaveToggle = document.getElementById('autoSaveToggle');
    const settingsBtn = document.getElementById('settings');
    const settingsMenu = document.getElementById('settingsMenu');
    const btnReloadAssets = document.getElementById('btnReloadAssets');
    const libraryModal = document.getElementById('libraryModal');
    const libraryGrid = document.getElementById('libraryGrid');
    const previewModal = document.getElementById('previewModal');
    const previewImage = document.getElementById('previewImage');
    const downloadPreviewBtn = document.getElementById('downloadPreview');
    const deletePreviewBtn = document.getElementById('deletePreview');
    let currentStream;
    let useFront = true;
    let photos = [];
    let activePhotoId = null;
    let autoSave = true;

    // ===== IndexedDB persistence =====
    const DB_NAME = 'camera-db';
    const DB_VERSION = 1;
    const STORE_PHOTOS = 'photos';

    function openDb() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(STORE_PHOTOS)) {
            const store = db.createObjectStore(STORE_PHOTOS, { keyPath: 'id' });
            store.createIndex('createdAt', 'createdAt');
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function dbSavePhoto(photo) {
      try {
        const db = await openDb();
        await new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_PHOTOS, 'readwrite');
          tx.objectStore(STORE_PHOTOS).put(photo);
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        });
      } catch (e) {
        console.error('Error saving photo to cache', e);
      }
    }

    async function dbDeletePhoto(id) {
      try {
        const db = await openDb();
        await new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_PHOTOS, 'readwrite');
          tx.objectStore(STORE_PHOTOS).delete(id);
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        });
      } catch (e) {
        console.error('Error deleting photo from cache', e);
      }
    }

    async function dbLoadAllPhotos() {
      try {
        const db = await openDb();
        return await new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_PHOTOS, 'readonly');
          const req = tx.objectStore(STORE_PHOTOS).getAll();
          req.onsuccess = () => {
            const list = req.result || [];
            // Sort newest first
            list.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            resolve(list);
          };
          req.onerror = () => reject(req.error);
        });
      } catch (e) {
        console.error('Error loading photos from cache', e);
        return [];
      }
    }

    async function initCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }
      const preferredConstraints = {
        video: {
          facingMode: useFront ? 'user' : 'environment',
          width: { ideal: 1920 },
          height: { ideal: 1080 },
          aspectRatio: { ideal: window.innerWidth / Math.max(1, window.innerHeight) },
        },
        audio: false,
      };
      const fallbackConstraints = {
        video: { facingMode: useFront ? 'user' : 'environment' },
        audio: false,
      };
      try {
        currentStream = await navigator.mediaDevices.getUserMedia(preferredConstraints);
      } catch (e1) {
        try {
          currentStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
        } catch (e2) {
          console.error('Cannot access camera', e2);
          alert('Cannot access camera. Please check access permissions or try a different browser.');
          return;
        }
      }
      video.muted = true;
      video.playsInline = true;
      video.srcObject = currentStream;
      // Mirror preview for front camera by default
      video.style.transform = useFront ? 'scaleX(-1)' : 'none';
    }

    captureBtn.onclick = () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      // Mirror captured image to match preview when using front camera
      ctx.save();
      if (useFront) {
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
      }
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      ctx.restore();
      const dataUrl = canvas.toDataURL('image/png');
      const photo = addPhoto(dataUrl);
      if (autoSave && photo) {
        downloadPhoto(photo.id);
      }
    };

    // Reinitialize camera on orientation change for better aspect match
    window.addEventListener('orientationchange', () => {
      setTimeout(() => initCamera(), 300);
    }, { passive: true });

    function addPhoto(dataUrl) {
      const id = 'p_' + Date.now() + '_' + Math.random().toString(36).slice(2, 8);
      const index = photos.length + 1;
      const filename = `photo_${index}.png`;
      const createdAt = Date.now();
      const photo = { id, dataUrl, filename, createdAt };
      photos.unshift(photo);
      renderThumbRow();
      if (libraryModal.classList.contains('show')) renderLibrary();
      // Save to IndexedDB for offline cache
      dbSavePhoto(photo);
      return photo;
    }

    function renderThumbRow() {
      // This function is no longer needed as gallery is removed.
      // The photo display is now handled by the preview modal.
    }

    function openLibrary() {
      renderLibrary();
      libraryModal.classList.add('show');
      libraryModal.setAttribute('aria-hidden', 'false');
    }

    function closeLibrary() {
      libraryModal.classList.remove('show');
      libraryModal.setAttribute('aria-hidden', 'true');
    }

    function renderLibrary() {
      libraryGrid.innerHTML = '';
      photos.forEach((p) => {
        const item = document.createElement('div');
        item.className = 'lib-item';
        item.dataset.id = p.id;

        const img = document.createElement('img');
        img.src = p.dataUrl;
        img.className = 'lib-thumb';
        img.alt = p.filename;
        img.addEventListener('click', () => openPreview(p.id));

        const actions = document.createElement('div');
        actions.className = 'lib-actions';

        const dl = document.createElement('button');
        dl.className = 'mini-btn ios-btn';
        dl.innerHTML = '<iconify-icon icon="ion:download-outline"></iconify-icon>';
        dl.addEventListener('click', (e) => {
          e.stopPropagation();
          downloadPhoto(p.id);
        });

        const del = document.createElement('button');
        del.className = 'mini-btn ios-btn';
        del.innerHTML = '<iconify-icon icon="ion:trash-outline"></iconify-icon>';
        del.addEventListener('click', (e) => {
          e.stopPropagation();
          deletePhoto(p.id);
        });

        actions.appendChild(dl);
        actions.appendChild(del);
        item.appendChild(img);
        item.appendChild(actions);
        libraryGrid.appendChild(item);
      });
    }

    function openPreview(photoId) {
      const photo = photos.find(x => x.id === photoId);
      if (!photo) return;
      activePhotoId = photoId;
      previewImage.src = photo.dataUrl;
      previewImage.alt = photo.filename;
      previewModal.classList.add('show');
      previewModal.setAttribute('aria-hidden', 'false');
    }

    function closePreview() {
      previewModal.classList.remove('show');
      previewModal.setAttribute('aria-hidden', 'true');
      activePhotoId = null;
    }

    function downloadPhoto(photoId) {
      const photo = photos.find(x => x.id === photoId);
      if (!photo) return;
      const a = document.createElement('a');
      a.href = photo.dataUrl;
      a.download = photo.filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function deletePhoto(photoId) {
      const i = photos.findIndex(x => x.id === photoId);
      if (i === -1) return;
      photos.splice(i, 1);
      renderThumbRow();
      if (libraryModal.classList.contains('show')) renderLibrary();
      if (activePhotoId === photoId) closePreview();
      // Delete from IndexedDB
      dbDeletePhoto(photoId);
    }

    document.getElementById('switchCam').onclick = () => {
      useFront = !useFront;
      initCamera();
    };

    // Auto save toggle
    function updateAutoSaveBtn() {
      const label = autoSave ? 'ON' : 'OFF';
      autoSaveToggle.innerHTML = '<iconify-icon icon="ion:save-outline"></iconify-icon><span>'+label+'</span>';
      autoSaveToggle.setAttribute('aria-pressed', String(autoSave));
    }
    autoSaveToggle.addEventListener('click', () => {
      autoSave = !autoSave;
      updateAutoSaveBtn();
    });
    updateAutoSaveBtn();

    // Toolbar: open library
    openLibraryBtn.addEventListener('click', openLibrary);

    // Close buttons and backdrop click
    libraryModal.addEventListener('click', (e) => {
      if (e.target === libraryModal || e.target.hasAttribute('data-close-lib')) closeLibrary();
    });
    previewModal.addEventListener('click', (e) => {
      if (e.target === previewModal || e.target.hasAttribute('data-close-preview')) closePreview();
    });

    // Preview actions
    downloadPreviewBtn.addEventListener('click', () => {
      if (activePhotoId) downloadPhoto(activePhotoId);
    });
    deletePreviewBtn.addEventListener('click', () => {
      if (activePhotoId) deletePhoto(activePhotoId);
    });

    // Initialize: load photos from cache then start camera
    (async () => {
      const cached = await dbLoadAllPhotos();
      if (Array.isArray(cached) && cached.length) {
        photos = cached;
        renderThumbRow();
      }
      initCamera();
    })();

    // ===== Service Worker Registration =====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then((reg) => {
          // Listen for updatefound to auto-activate new SW
          if (reg.waiting) {
            reg.waiting.postMessage({ type: 'SKIP_WAITING' });
          }
          reg.addEventListener('updatefound', () => {
            const nw = reg.installing;
            if (!nw) return;
            nw.addEventListener('statechange', () => {
              if (nw.state === 'installed' && navigator.serviceWorker.controller) {
                // New version installed; optionally notify user
              }
            });
          });
        }).catch(() => {});
      });
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'RELOAD_NOW') {
          window.location.reload(true);
        }
      });
    }

    // ===== Settings menu actions =====
    function toggleSettingsMenu(show) {
      const willShow = typeof show === 'boolean' ? show : !settingsMenu.classList.contains('show');
      if (willShow) {
        settingsMenu.classList.add('show');
        settingsMenu.setAttribute('aria-hidden', 'false');
      } else {
        settingsMenu.classList.remove('show');
        settingsMenu.setAttribute('aria-hidden', 'true');
      }
    }
    settingsBtn.addEventListener('click', () => toggleSettingsMenu());
    document.addEventListener('click', (e) => {
      const within = settingsMenu.contains(e.target) || settingsBtn.contains(e.target);
      if (!within) toggleSettingsMenu(false);
    }, { passive: true });

    btnReloadAssets.addEventListener('click', async () => {
      try {
        const reg = await navigator.serviceWorker.getRegistration();
        if (reg && reg.active) {
          reg.active.postMessage({ type: 'CLEAR_AND_RELOAD' });
          // Give SW a moment to clear caches, then hard reload
          setTimeout(() => window.location.reload(true), 300);
        } else {
          // Fallback: clear caches via CacheStorage API then reload
          if ('caches' in window) {
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k)));
          }
          window.location.reload(true);
        }
      } catch (e) {
        window.location.reload(true);
      }
    });
  </script>
</body>
</html>
